<div class="igdb-search-container" @fadeInUp>
  <!-- Header -->
  <div class="page-header">
    <button mat-icon-button routerLink="/games" class="back-btn">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <h1>ðŸŽ® Add Games</h1>
      <p>Search IGDB to find and add games to your library</p>
    </div>
    <button mat-stroked-button routerLink="/games/new" class="manual-btn">
      <mat-icon>edit</mat-icon>
      Add Manually
    </button>
  </div>

  <!-- Search Bar -->
  <div class="search-section">
    <div class="search-bar">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (input)="onSearchInput()"
        placeholder="Search for games..."
        class="search-input"
        autofocus
      />
      @if (searchQuery) {
        <button mat-icon-button class="clear-btn" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      }
      @if (searching) {
        <mat-spinner diameter="24" class="search-spinner"></mat-spinner>
      }
    </div>
    
    <!-- Filter Toggle -->
    <div class="filter-section">
      <button 
        class="filter-btn"
        [class.active]="showSteamOnly"
        (click)="toggleSteamFilter()"
        matTooltip="Only show games found in your Steam library"
      >
        <svg class="steam-icon" viewBox="0 0 24 24" width="18" height="18">
          <path fill="currentColor" d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0zM7.54 18.21l-1.473-.61c.262.543.714.999 1.314 1.25 1.297.539 2.793-.076 3.332-1.375.263-.63.264-1.319.005-1.949s-.75-1.121-1.377-1.383c-.624-.26-1.29-.249-1.878-.03l1.523.63c.956.4 1.409 1.5 1.009 2.455-.397.957-1.497 1.41-2.454 1.012H7.54zm11.415-9.303c0-1.662-1.353-3.015-3.015-3.015-1.665 0-3.015 1.353-3.015 3.015 0 1.665 1.35 3.015 3.015 3.015 1.663 0 3.015-1.35 3.015-3.015zm-5.273-.005c0-1.252 1.013-2.266 2.265-2.266 1.249 0 2.266 1.014 2.266 2.266 0 1.251-1.017 2.265-2.266 2.265-1.253 0-2.265-1.014-2.265-2.265z"/>
        </svg>
        Steam Library Only
        @if (showSteamOnly) {
          <mat-icon class="filter-check">check</mat-icon>
        }
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'search'"
      (click)="onTabChange('search')"
    >
      <mat-icon>search</mat-icon>
      Search Results
      @if (searchResults.length > 0) {
        <span class="badge">{{ getFilteredCount(searchResults) }}</span>
      }
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'popular'"
      (click)="onTabChange('popular')"
    >
      <mat-icon>trending_up</mat-icon>
      Popular
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'recent'"
      (click)="onTabChange('recent')"
    >
      <mat-icon>new_releases</mat-icon>
      Recent Releases
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'upcoming'"
      (click)="onTabChange('upcoming')"
    >
      <mat-icon>event</mat-icon>
      Upcoming
    </button>
  </div>

  <!-- Results -->
  <div class="results-section">
    @if (loading) {
      <div class="loading-state">
        <mat-spinner diameter="48"></mat-spinner>
        <p>Loading games...</p>
      </div>
    } @else if (activeTab === 'search' && !searchQuery) {
      <div class="empty-state">
        <mat-icon>search</mat-icon>
        <h3>Search for Games</h3>
        <p>Enter a game title to search the IGDB database</p>
        <div class="search-tips">
          <span class="tip">ðŸ’¡ Try searching for "Zelda", "Final Fantasy", or "Dark Souls"</span>
        </div>
      </div>
    } @else if (activeTab === 'search' && searchQuery && getDisplayGames().length === 0 && !searching) {
      <div class="empty-state">
        <mat-icon>search_off</mat-icon>
        <h3>No Results for "{{ searchQuery }}"</h3>
        <p>Try adjusting your search or check the spelling</p>
        <button mat-stroked-button (click)="clearSearch()" class="try-again-btn">
          <mat-icon>refresh</mat-icon>
          Clear Search
        </button>
      </div>
    } @else if (getDisplayGames().length === 0) {
      <div class="empty-state">
        <mat-icon>videogame_asset_off</mat-icon>
        <h3>No Games Found</h3>
        <p>Try a different search term or browse other tabs</p>
      </div>
    } @else {
      <div class="games-grid">
        @for (game of getDisplayGames(); track trackByGame($index, game)) {
          <div class="game-card" @cardAnimation>
            <div class="card-cover">
              @if (game.coverUrl) {
                <img [src]="game.coverUrl" [alt]="game.name" loading="lazy" />
              } @else {
                <div class="no-cover">
                  <mat-icon>videogame_asset</mat-icon>
                </div>
              }
              
              <!-- Rating Badge -->
              @if (game.rating) {
                <div class="rating-badge">
                  <mat-icon>star</mat-icon>
                  {{ formatRating(game.rating) }}
                </div>
              }
            </div>

            <div class="card-content">
              <h3 class="game-title">{{ game.name }}</h3>
              
              <div class="game-meta">
                @if (game.releaseYear) {
                  <span class="meta-item">
                    <mat-icon>calendar_today</mat-icon>
                    {{ game.releaseYear }}
                  </span>
                }
                @if (game.developer) {
                  <span class="meta-item">
                    <mat-icon>code</mat-icon>
                    {{ game.developer }}
                  </span>
                }
              </div>

              @if (game.genres && game.genres.length > 0) {
                <div class="genres">
                  @for (genre of game.genres.slice(0, 3); track genre) {
                    <span class="genre-tag">{{ genre }}</span>
                  }
                </div>
              }

              @if (game.platforms && game.platforms.length > 0) {
                <div class="platforms">
                  @for (platform of game.platforms.slice(0, 4); track platform) {
                    <span class="platform-tag">{{ platform }}</span>
                  }
                  @if (game.platforms.length > 4) {
                    <span class="platform-tag more">+{{ game.platforms.length - 4 }}</span>
                  }
                </div>
              }

              @if (game.summary) {
                <p class="game-summary">{{ game.summary | slice:0:120 }}{{ game.summary.length > 120 ? '...' : '' }}</p>
              }
            </div>

            <div class="card-actions">
              @if (game.steamAppId) {
                <div class="steam-library-badge">
                  <svg class="steam-icon" viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0-3.016-1.173-3.331-2.727L.436 15.27C1.862 20.307 6.486 24 11.979 24c6.627 0 11.999-5.373 11.999-12S18.605 0 11.979 0zM7.54 18.21l-1.473-.61c.262.543.714.999 1.314 1.25 1.297.539 2.793-.076 3.332-1.375.263-.63.264-1.319.005-1.949s-.75-1.121-1.377-1.383c-.624-.26-1.29-.249-1.878-.03l1.523.63c.956.4 1.409 1.5 1.009 2.455-.397.957-1.497 1.41-2.454 1.012H7.54zm11.415-9.303c0-1.662-1.353-3.015-3.015-3.015-1.665 0-3.015 1.353-3.015 3.015 0 1.665 1.35 3.015 3.015 3.015 1.663 0 3.015-1.35 3.015-3.015zm-5.273-.005c0-1.252 1.013-2.266 2.265-2.266 1.249 0 2.266 1.014 2.266 2.266 0 1.251-1.017 2.265-2.266 2.265-1.253 0-2.265-1.014-2.265-2.265z"/>
                  </svg>
                  <span>In Steam Library</span>
                  <a 
                    [href]="'https://store.steampowered.com/app/' + game.steamAppId"
                    target="_blank"
                    rel="noopener"
                    class="steam-link"
                    matTooltip="View on Steam Store"
                    (click)="$event.stopPropagation()"
                  >
                    <mat-icon>open_in_new</mat-icon>
                  </a>
                </div>
              }
              @if (isGameInBacklog(game)) {
                <button 
                  mat-flat-button 
                  class="already-in-backlog-btn"
                  disabled
                >
                  <mat-icon>library_add_check</mat-icon>
                  Already in Backlog
                </button>
              } @else if (isGameAdded(game)) {
                <button 
                  mat-flat-button 
                  class="added-btn"
                  disabled
                >
                  <mat-icon>check_circle</mat-icon>
                  Added
                </button>
              } @else {
              <button 
                mat-flat-button 
                color="primary" 
                class="add-btn"
                (click)="importGame(game)"
                [disabled]="importingId === game.igdbId"
              >
                @if (importingId === game.igdbId) {
                  <mat-spinner diameter="20"></mat-spinner>
                  <span>Adding...</span>
                } @else {
                  <ng-container>
                    <mat-icon>add</mat-icon>
                    <span>Add to Library</span>
                  </ng-container>
                }
              </button>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>